<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CharWars</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="flex-container-column-default">
    <!--<div><button id='close-button' onclick='self.close()'>Close</button></div>-->
    <!-- <span class="flex-container-column-default"><button id='close-button'><a href="index.html">Close</a></button></span> -->
    <div class="flex-container-column-default" id="gameArea">

        <div class="flex-container-row-default" id="highScoreHeader">
            <span id="userName">not logged in</span>

            <span>
                <!-- <span>High Score:</span> -->
                <span id="highScore">0</span>
            </span>

            <!-- <span> -->
                <span><b><a id="close-anchor-tag" href="index.html">&nbsp;&times&nbsp;</a></b></span>
                <!-- <span>Days:</span> -->
                <!-- <span id="daysAtHighScore">182</span> -->
            <!-- </span> -->

        </div>
        <div class="flex-container-row-default" id="scoreboard">
            <span>
                <span>Level:</span>
                <span id="level">100</span>
            </span>

            <span>
                <span>Score:</span>
                <span id="score">100</span>
            </span>

            <span>
                <span>Lives:</span>
                <span id="lives">100</span>
            </span>
        </div>
        <div id="playArea">
            <button id="start-button">Begin</button>
            <button id="restart-button">Play Again</button>

        </div>
        <!-- normal -->
        <div id="controlsArea">
            <div id="space"><button id="btnSpace">&#8861;</button></div>
            <div id="left"><button id="btnLeft">&#8678;</button></div>
            <div id="right"><button id="btnRight">&#8680;</button></div>
            <div id="up"><button id="btnUp">&#8679;</button></div>
            <div id="down"><button id="btnDown">&#8681;</button></div>
        </div>
    </div>

<script src="video-game-library.js"></script>
<script>

// ---------------------------GAME HERE----------------------------


        //-------1-------define audio-------1-------
        function defineAudio() {

            introMusic = new Tone(330, 2000, "sine", 0, 0, 0);
            //introMusic = new Audio("intro99bottles.mp3");

            insertcoin = new Tone(110, 200, "triangle", 0, 0, -6);
            //insertcoin = new Audio("insertcoin.mp3");

            breakingGlass = new Tone(110, 300, "sawtooth", 0, 0, -15);
            //breakingGlass = new Audio("breakingglass.mp3");
        }

        //-------2-------define frame rate-------2-------
        framesPerSecond = 45;
        let interval = (1.0 / framesPerSecond) * 1000;

        //-------3-------Initialize Game Put Stuff on Screen Define Variables-------3-------
        //let secretKey = "";
        //let gameIdentifier = "";
        userName = "mystery person";
        let lastBottleCaught = false;
        let firstRun = true;
        let bottleGame = new MyLittleVideoGame("99 Bottles");
        //options     slr   sud lr  ud s lrud standard
        useControls("lr");
        bottleGame.setBackgroundColor("beige");
        bottleGame.setLives(7);
        bindControlsToWindow(bottleGame);
        bindButtonControls(bottleGame);
        leftBorder = 0;
        topBorder = 0;
        playAreaHeight = bottleGame.playAreaHeight;
        playAreaWidth = bottleGame.playAreaWidth;
        //make bottles
        const columnwidth = playAreaWidth / 11.0;
        const columnheight = 20;
        let bottles = [];
        for (let j = 0; j < 10; j++) {
            let row = [];
            for (let i = 0; i < 10; i++) {
                let tempCharacter = new GameCharacter("bottle" + i.toString(), "&#127866", (i + 1) * columnwidth, (j + 2) * columnheight, 0, bottleGame, "1rem");
                row.push(tempCharacter);
            }
            bottles.push(row);
        }
        const bartender = new GameCharacter("bartender", "&#128116", columnwidth, columnheight, 0, bottleGame, "1.4rem");
        moveCharacterTo(bartender, columnwidth, bartender.getCharacterHeight());
        const catcher = new GameCharacter("catcher", "&#128080", playAreaWidth / 2.0, playAreaHeight, 0, bottleGame, "2rem");
        moveCharacterBy(catcher, 0, -catcher.getCharacterHeight());
        let bottleRow = 0;
        let bottleNumber = 0;
        let xVel = 0;
        let yAcc = 0;
        if (bottleNumber < 5) {
            xVel = 2;
        } else {
            xVel = -2;
        }
        yAcc = 0.3;
        let timeCount = 0;
        currentBottle = bottles[bottleRow][bottleNumber];
        let caught = true;

        //-------4-------make game run with start button and restart buttons -------4-------
        document.getElementById("start-button").addEventListener("click", startGame);
        document.getElementById("restart-button").addEventListener("click", () => location.reload());

        function startGame() {
            //makes start button dissappear
            this.style.display = "none";
            defineAudio();
            //start game loop
            soundplay(introMusic);
            // alert(userName);
            setTimeout(() => {
                myGameLoopTicker = setInterval(gameLoop, interval);
            }, 7000);

        }

        //-------5------- Make Game Loop -------5-------
        function gameLoop() {
            //move catcher
            respondToControlsWithMove(catcher, -7, 7, 0, 0);
            //move current bottle
            moveCharacterBy(currentBottle, xVel, yAcc * timeCount)
                //check for catch
            if (collisionDetect(catcher, currentBottle) == true) {
                catchMessage = new GameCharacter("caughtmessageid", "Good catch!", playAreaWidth * .9, playAreaHeight * .75, 30, bottleGame, "1rem");
                // catchMessage.setBackgroundColor("tan");
                catchMessage.setColor("green");
                soundplay(insertcoin);
                bottleGame.addToScore(1);
                caughtBottle = currentBottle;
                caughtBottle.setText("");
                bottleNumber += 1;
                bottleNumber = bottleNumber % 10;
                if (bottleRow == 9 && bottleNumber == 9) {
                    winMessage = new GameCharacter("winmessageid", "You Won!", playAreaWidth / 2.0, playAreaHeight * .75, 0, bottleGame, "1rem");
                    soundplay(introMusic);
                    //end of game reached
                    clearInterval(myGameLoopTicker);
                } else {
                    if (bottleNumber == 0) {
                        bottleRow += 1;
                    }
                    if (bottleNumber < 5) {
                        xVel = 2;
                    } else {
                        xVel = -2;
                    }
                }
                timeCount = 0;
                currentBottle = bottles[bottleRow][bottleNumber];
                moveCharacterTo(bartender, currentBottle.xPosition, (bottleRow + 1) * columnheight);
                setTimeout(() => {
                    removeCharacter(catchMessage);
                }, 777)
            }
            // check for collision with ground
            if (currentBottle.yPosition >= playAreaHeight) {
                soundplay(breakingGlass);
                bottleGame.subtractLives(1);
                groundBottle = currentBottle;
                groundBottle.setText("");
                bottleNumber += 1;
                bottleNumber = bottleNumber % 10;
                if ((bottleRow == 9 && bottleNumber == 9 && bottleGame.getLives() > 0)) { //end of bottles, still with lives wins
                    message = new GameCharacter("messageid", "You Won!", playAreaWidth / 2.0, playAreaHeight * .75, 0, bottleGame, "1rem");
                    //end of game reached
                    soundplay(introMusic);
                    clearInterval(myGameLoopTicker);
                } else if (
                    (bottleRow == 9 && bottleNumber == 9 && bottleGame.getLives() <= 0) ||
                    (bottleGame.getLives() <= 0)
                ) { //end of bottles, no lives loses


                    message = new GameCharacter("messageid", "Game Over", playAreaWidth / 2.0, playAreaHeight * .75, 0, bottleGame, "1rem");
                    //end of game reached
                    soundplay(introMusic);
                    clearInterval(myGameLoopTicker);


                    // /////////////UPDATE SCORES IN DATABASE /////////////

                    // let finalScore = parseInt(document.getElementById("score").innerHTML);
                    // let currentHighScore = parseInt(document.getElementById("highScore").innerHTML);

                    // if (finalScore > currentHighScore) {

                    //     alert('new high score');
                    //     let online = navigator.onLine;
                    //     //alert("online");
                    //     //alert(online);

                    //     if (online != false) {

                    //         gameIdentifier = gameIdentifier;
                    //         secretKey = secretKey;

                    //         //using POST//
                    //         let xmlhttp = new XMLHttpRequest();
                    //         xmlhttp.open('POST', '../../includes/insert-new-highscore.php', true);
                    //         xmlhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                    //         xmlhttp.onload = function() {
                    //             // do something with response or after response
                    //             //console.log(this.responseText);
                    //             window.location.href = window.location.href; //reload window because there is not high score
                    //         };

                    //         let postString = 'gameidentifier=' + gameIdentifier + '&finalscore=' + finalScore + '&secretkey=' + secretKey;
                    //         //alert(postString);
                    //         xmlhttp.send(postString);
                    //     }
                    // }

                    // ////////////////////////////////////////////////////

                    setTimeout(() => {
                        removeCharacter(message);
                        //-------6------- At end of game, add start button back-------6-------
                        document.getElementById("restart-button").style.display = "inline-block";
                    }, 5000)
                } else {
                    if (bottleNumber == 0) {
                        bottleRow += 1;
                    }
                    if (bottleNumber < 5) {
                        xVel = 2;
                    } else {
                        xVel = -2;
                    }
                    hitsGroundMessage = new GameCharacter("hitsground", "Crash!", .1 * playAreaWidth, .75 * playAreaHeight, -30, bottleGame, "1rem");
                    hitsGroundMessage.setColor("red");
                    setTimeout(() => {
                        removeCharacter(hitsGroundMessage);
                    }, 500);
                }
                timeCount = 0;
                currentBottle = bottles[bottleRow][bottleNumber];
                moveCharacterTo(bartender, currentBottle.xPosition, (bottleRow + 1) * columnheight);
            }
            timeCount += 1;
        }


        //----------0-------android games modifications---------------
        //<main character>🍺</main character>
        document.getElementById("userName").innerHTML = window.document.title;
        document.getElementById("highScore").innerHTML = "<a href='https://www.charwars.net'>CharWars</>";
    </script>
</body>

</html>